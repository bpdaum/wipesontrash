<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ guild_name }} - Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; /* gray-100 */ }
        th {
            text-align: left; padding: 0.5rem 0.75rem; background-color: #f7fafc; /* gray-100 */
            border-bottom: 2px solid #e2e8f0; /* gray-300 */ font-weight: 600; /* Semibold */
            white-space: nowrap;
        }
        /* Clickable sortable headers */
        th.sortable { cursor: pointer; position: relative; }
        th.sortable:hover { background-color: #edf2f7; /* gray-200 */ }
        /* Sort arrows */
        .sort-arrow {
            font-size: 0.8em; margin-left: 0.3em; color: #a0aec0; /* gray-500 */ position: absolute;
            right: 0.5rem; top: 50%; transform: translateY(-50%); width: 1em; text-align: center;
        }
        .sort-arrow.asc::after { content: '\25B2'; } /* Up arrow ▲ */
        .sort-arrow.desc::after { content: '\25BC'; } /* Down arrow ▼ */
        /* Table cell styles */
        td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #e2e8f0; /* gray-300 */ vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        /* Utility styles */
        .na-value { color: #a0aec0; /* gray-500 */ font-style: italic; }
        .armory-link { color: #2b6cb0; /* blue-700 */ text-decoration: none; }
        .armory-link:hover { color: #2c5282; /* blue-800 */ text-decoration: underline; }
        .role-icon { font-size: 1.1rem; width: 1.5em; text-align: center; display: inline-block; }
        .role-dps { color: #c53030; } .role-healer { color: #2f855a; } .role-tank { color: #2b6cb0; } .role-unknown { color: #a0aec0; }

        /* Styles for Editing (shared for spec and status) */
        .display-value { display: inline-block; margin-right: 5px;}
        .edit-btn {
            cursor: pointer; color: #a0aec0; font-size: 0.8em; vertical-align: middle; display: inline-block;
            padding: 1px 3px; border-radius: 3px; margin-left: 4px;
        }
        .edit-btn:hover { color: #4a5568; background-color: #e2e8f0;}
        .edit-control { /* Common class for selects */
            display: none; padding: 2px 4px; border: 1px solid #cbd5e0; border-radius: 4px;
            font-size: 0.9em; vertical-align: middle; margin-left: 5px; max-width: 150px;
        }
        .edit-container { display: inline-block; } /* Container for select and save/cancel */
        .save-btn, .cancel-btn {
            display: none; margin-left: 5px; padding: 1px 4px; font-size: 0.8em; border-radius: 3px; cursor: pointer;
            vertical-align: middle; border: 1px solid transparent;
        }
        .save-btn { background-color: #38a169; color: white; border-color: #2f855a;}
        .save-btn:hover { background-color: #2f855a; }
        .cancel-btn { background-color: #e53e3e; color: white; border-color: #c53030;}
        .cancel-btn:hover { background-color: #c53030; }
        .update-status { font-size: 0.8em; margin-left: 5px; font-style: italic; color: #4a5568; }

        /* Status Text Styling */
        .status-wiper { color: #b7791f; font-weight: 500;}
        .status-member { color: #38a169; }
        .status-wiping-alt { color: #718096; }
        /* Add styles for user-settable statuses if needed */
        /* .status-raid { } */
        /* .status-casual { color: #4299e1; } */
        /* .status-alt { color: #9f7aea; } */

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="text-white p-4 shadow-md" style="background-color: #6B1A51;">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                 <img src="{{ url_for('static', filename='images/wot_logo.png') }}"
                      alt="{{ guild_name }} Logo"
                      class="h-8 w-8 rounded-full border-2 border-white">
                 <h1 class="text-xl font-semibold">{{ guild_name }} - Area 52</h1>
            </div>
            <div class="flex space-x-2">
                <a href="/" class="px-3 py-2 rounded hover:bg-gray-600">Home</a>
                <a href="/roster" class="px-3 py-2 rounded bg-gray-700 font-medium hover:bg-gray-600">Roster</a>
                <a href="#" class="px-3 py-2 rounded hover:bg-gray-600">Raids</a>
                <a href="#" class="px-3 py-2 rounded hover:bg-gray-600">Loot</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto mt-8 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold">Guild Roster</h2>
                 {% if load_duration %}
                 <span class="text-sm text-gray-500">Loaded in {{ load_duration }}s</span>
                 {% endif %}
            </div>

            {% if error_message %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline">{{ error_message }}</span>
            </div>
            {% endif %}

            {% if members %}
            <div class="overflow-x-auto">
                <table id="rosterTable" class="min-w-full whitespace-nowrap">
                    <thead>
                        <tr>
                            <th class="sortable" data-column-index="0" data-sort-type="string">Name <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="1" data-sort-type="number">Level <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="2" data-sort-type="string">Role <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="3" data-sort-type="string">Spec <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="4" data-sort-type="string">Class <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="5" data-sort-type="number">Item Level <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="6" data-sort-type="string">Status <span class="sort-arrow"></span></th> {# Status Header #}
                            <th class="sortable" data-column-index="7" data-sort-type="string">Progression <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="8" data-sort-type="number">Rank <span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody id="rosterBody">
                        {% for member in members %}
                        {# Add character and class IDs to the row for JavaScript access #}
                        <tr data-character-id="{{ member.id }}" data-class-id="{{ member.class_id }}" data-api-spec="{{ member.spec_name }}">
                            <td>
                                <a href="https://worldofwarcraft.blizzard.com/{{ wow_locale }}/character/{{ wow_region }}/{{ member.realm_slug }}/{{ member.name | urlencode }}"
                                   target="_blank" rel="noopener noreferrer" class="armory-link">
                                    {{ member.name }}
                                </a>
                            </td>
                            <td>{{ member.level }}</td>
                             <td class="text-center role-cell"> {# Center align the icon #}
                                {% set role_lower = member.role | lower if member.role else '' %}
                                {% if role_lower == 'dps' %} <i class="fa-solid fa-khanda role-icon role-dps" title="DPS"></i>
                                {% elif role_lower == 'healer' %} <i class="fa-solid fa-briefcase-medical role-icon role-healer" title="Healer"></i>
                                {% elif role_lower == 'tank' %} <i class="fa-solid fa-shield-halved role-icon role-tank" title="Tank"></i>
                                {% else %} <i class="fa-solid fa-question role-icon role-unknown" title="Unknown/N/A"></i> {% endif %}
                            </td>
                            <td> {# Spec Column #}
                                <span class="spec-display display-value">
                                    {# Display override if set, otherwise API spec #}
                                    {% if member.main_spec_override %}
                                        {{ member.main_spec_override }}
                                    {% elif member.spec_name == "N/A" or member.spec_name is none %}
                                        <span class="na-value">N/A</span>
                                    {% else %}
                                        {{ member.spec_name }} {# Display API spec if no override #}
                                    {% endif %}
                                </span>
                                <i class="fas fa-pencil-alt edit-btn edit-spec-btn" title="Set Main Spec"></i> {# Edit Icon #}
                                <div class="edit-container spec-edit-container"> {# Container #}
                                    <select class="edit-control spec-select">
                                        {# Options will be populated by JavaScript based on class_id #}
                                    </select>
                                    <button class="save-btn spec-save-btn">Save</button>
                                    <button class="cancel-btn spec-cancel-btn">Cancel</button>
                                </div>
                                <span class="update-status spec-update-status"></span> {# Specific class #}
                            </td>
                            <td>{{ member.class }}</td>
                             <td>
                                {% if member.item_level == "N/A" or member.item_level is none %} <span class="na-value">N/A</span> {% else %} {{ member.item_level }} {% endif %}
                            </td>
                            {# --- Status Column with Edit --- #}
                            <td>
                                <span class="status-display display-value">
                                     {# Apply styling based on status #}
                                     {% set status_lower = member.status | lower if member.status else '' %}
                                     <span class="
                                         {% if status_lower == 'wiper' %} status-wiper
                                         {% elif status_lower == 'member' %} status-member
                                         {% elif status_lower == 'wiping alt' %} status-wiping-alt
                                         {% elif status_lower == 'raid' %} status-raid {# Keep styles just in case #}
                                         {% elif status_lower == 'casual' %} status-casual
                                         {% elif status_lower == 'alt' %} status-alt
                                         {% endif %}">
                                         {{ member.status | default('Unknown') }} {# Display current status #}
                                     </span>
                                </span>
                                <i class="fas fa-pencil-alt edit-btn edit-status-btn" title="Set Status"></i> {# Edit Icon #}
                                <div class="edit-container status-edit-container"> {# Container #}
                                    <select class="edit-control status-select">
                                        {# Options match desired user-settable values #}
                                        <option value="Wiper">Wiper</option>
                                        <option value="Member">Member</option>
                                        <option value="Wiping Alt">Wiping Alt</option>
                                    </select>
                                    <button class="save-btn status-save-btn">Save</button>
                                    <button class="cancel-btn status-cancel-btn">Cancel</button>
                                </div>
                                <span class="update-status status-update-status"></span> {# Specific class #}
                            </td>
                            {# --- END STATUS --- #}
                            <td>
                                {% if member.raid_progression == "N/A" or member.raid_progression is none %} <span class="na-value">N/A</span> {% else %} {{ member.raid_progression }} {% endif %}
                            </td>
                            <td>{{ member.rank }}</td>
                        </tr>
                        {% endfor %} {# End of member loop #}
                    </tbody>
                </table>
            </div>
            {% elif not error_message %}
            {# Message if no members match the filter criteria #}
            <p>No members found matching rank criteria (<= 4) and item level (>= 600) in the database.</p>
            {% endif %} {# End of members check #}
        </div>
    </main>

    <footer class="text-center text-gray-500 mt-8 pb-4">
        &copy; {{ guild_name }} - {{ current_year }} {# Assuming current_year is passed from Flask #}
    </footer>

    <script>
        // Parse the spec data passed from Flask
        const allSpecsByClass = JSON.parse('{{ all_specs_by_class | safe }}' || '{}');

        // --- Role Determination Logic ---
        const tankSpecs = ["Blood", "Protection", "Guardian", "Brewmaster", "Vengeance"];
        const healerSpecs = ["Holy", "Discipline", "Restoration", "Mistweaver", "Preservation"];
        function getRoleFromSpec(specName) {
            if (!specName || specName === 'N/A') return 'Unknown';
            if (tankSpecs.includes(specName)) return 'Tank';
            if (healerSpecs.includes(specName)) return 'Healer';
            return 'DPS';
        }

        // --- UI Update Functions ---
        function updateRoleIcon(tableRow, newRole) {
            const roleCell = tableRow.querySelector('.role-cell');
            if (!roleCell) return;
            const icon = roleCell.querySelector('i');
            if (!icon) return;
            icon.className = 'role-icon fa-solid'; // Reset classes
            let iconClass = 'fa-question', colorClass = 'role-unknown', title = 'Unknown/N/A';
            if (newRole === 'DPS') { iconClass = 'fa-khanda'; colorClass = 'role-dps'; title = 'DPS'; }
            else if (newRole === 'Healer') { iconClass = 'fa-briefcase-medical'; colorClass = 'role-healer'; title = 'Healer'; }
            else if (newRole === 'Tank') { iconClass = 'fa-shield-halved'; colorClass = 'role-tank'; title = 'Tank'; }
            icon.classList.add(iconClass, colorClass);
            icon.setAttribute('title', title);
        }

        function updateStatusDisplay(displaySpan, newStatus) {
             const innerSpan = displaySpan.querySelector('span'); // Target the inner span for styling
             if (!innerSpan) return;
             // Remove existing status classes
             innerSpan.className = ''; // Clear all classes first
             // Add new class based on the status value
             if (newStatus) {
                 // Create class name like 'status-wiping-alt'
                 const statusClass = 'status-' + newStatus.toLowerCase().replace(' ', '-');
                 innerSpan.classList.add(statusClass);
             }
             innerSpan.textContent = newStatus || 'Unknown'; // Update text
        }


        // --- Main Script Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('rosterTable');
            const tableBody = document.getElementById('rosterBody');
            if (!table || !tableBody) { console.error("Roster table or body not found!"); return; }
            const headers = table.querySelectorAll('th.sortable');
            let currentSort = { column: -1, ascending: true }; // Track current sort state

            // --- Sorting Event Listeners ---
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const columnIndex = parseInt(this.dataset.columnIndex);
                    const sortType = this.dataset.sortType || 'string';
                    let ascending = (currentSort.column === columnIndex) ? !currentSort.ascending : true;
                    currentSort = { column: columnIndex, ascending: ascending };
                    sortTable(columnIndex, sortType, ascending);
                    updateSortArrows(headers, columnIndex, ascending);
                });
            });

            // --- Editing Event Listeners (using event delegation) ---
            tableBody.addEventListener('click', function(event) {
                // Spec Editing
                if (event.target.classList.contains('edit-spec-btn')) { startEdit(event.target, 'spec'); }
                else if (event.target.classList.contains('spec-save-btn')) { saveEdit(event.target, 'spec'); }
                else if (event.target.classList.contains('spec-cancel-btn')) { cancelEdit(event.target, 'spec'); }
                // Status Editing
                else if (event.target.classList.contains('edit-status-btn')) { startEdit(event.target, 'status'); }
                else if (event.target.classList.contains('status-save-btn')) { saveEdit(event.target, 'status'); }
                else if (event.target.classList.contains('status-cancel-btn')) { cancelEdit(event.target, 'status'); }
            });

            // --- Generic Editing Functions ---
            function startEdit(editButton, type) { // type is 'spec' or 'status'
                const td = editButton.closest('td');
                const tr = editButton.closest('tr');
                const displaySpan = td.querySelector(`.${type}-display`);
                const selectContainer = td.querySelector(`.${type}-edit-container`);
                const select = selectContainer.querySelector(`.${type}-select`);
                const saveBtn = selectContainer.querySelector(`.${type}-save-btn`);
                const cancelBtn = selectContainer.querySelector(`.${type}-cancel-btn`);
                const statusSpan = td.querySelector(`.${type}-update-status`);

                // Find the inner span for status to get the correct text value
                const currentDisplayedValue = (type === 'status')
                    ? displaySpan.querySelector('span').textContent.trim()
                    : displaySpan.textContent.trim();


                // Populate dropdown if it's for spec
                if (type === 'spec') {
                    const classId = tr.dataset.classId;
                    const specsForClass = allSpecsByClass[classId] || [];
                    select.innerHTML = '<option value="">-- Use API Spec --</option>'; // Option to clear override
                    specsForClass.forEach(spec => {
                        const option = document.createElement('option');
                        option.value = spec.name; option.textContent = spec.name;
                        // Select current value (handle N/A case)
                        if (currentDisplayedValue === spec.name && !displaySpan.querySelector('.na-value')) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else if (type === 'status') {
                     // Pre-select current status for Status dropdown
                     Array.from(select.options).forEach(option => {
                         option.selected = (option.value === currentDisplayedValue);
                     });
                }

                // Show editing UI
                displaySpan.style.display = 'none'; editButton.style.display = 'none';
                selectContainer.style.display = 'inline-block'; select.style.display = 'inline-block';
                saveBtn.style.display = 'inline-block'; cancelBtn.style.display = 'inline-block';
                statusSpan.textContent = '';
            }

            function cancelEdit(cancelButton, type) {
                 const td = cancelButton.closest('td');
                 const displaySpan = td.querySelector(`.${type}-display`);
                 const editButton = td.querySelector(`.edit-${type}-btn`);
                 const selectContainer = td.querySelector(`.${type}-edit-container`);
                 selectContainer.style.display = 'none';
                 displaySpan.style.display = 'inline-block';
                 editButton.style.display = 'inline-block';
            }

            function saveEdit(saveButton, type) { // type is 'spec' or 'status'
                const td = saveButton.closest('td');
                const tr = saveButton.closest('tr');
                const select = td.querySelector(`.${type}-select`);
                const statusSpan = td.querySelector(`.${type}-update-status`);
                const characterId = tr.dataset.characterId;
                const selectedValue = select.value;

                if (!characterId) { /* ... error handling ... */ return; }
                statusSpan.textContent = 'Saving...'; statusSpan.style.color = '#4a5568';

                // Determine endpoint and payload based on type
                let endpoint = '';
                let payload = {};
                if (type === 'spec') {
                    endpoint = '/update_spec';
                    payload = { character_id: parseInt(characterId), spec_name: selectedValue };
                } else if (type === 'status') {
                    endpoint = '/update_status';
                    payload = { character_id: parseInt(characterId), status: selectedValue };
                } else { return; }

                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(errData => { throw new Error(errData.description || `HTTP error ${response.status}`); })
                                           .catch(() => { throw new Error(`HTTP error ${response.status}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusSpan.textContent = 'Saved!'; statusSpan.style.color = 'green';
                        const displaySpan = td.querySelector(`.${type}-display`);

                        if (type === 'spec') {
                            const apiSpecName = tr.dataset.apiSpec;
                            let finalSpecName = selectedValue ? selectedValue : apiSpecName;
                            // Update display text
                            displaySpan.textContent = (finalSpecName && finalSpecName !== "N/A") ? finalSpecName : '';
                            if (!displaySpan.textContent) displaySpan.innerHTML = '<span class="na-value">N/A</span>';
                            // Update role icon
                            const newRole = getRoleFromSpec(finalSpecName);
                            updateRoleIcon(tr, newRole);
                        } else if (type === 'status') {
                             // Update status display text and style
                             updateStatusDisplay(displaySpan, selectedValue); // Pass the outer span
                        }

                        setTimeout(() => { cancelEdit(saveButton, type); statusSpan.textContent = ''; }, 1500);
                    } else { throw new Error(data.message || "Unknown error saving data."); }
                })
                .catch(error => {
                    console.error(`Error updating ${type}:`, error);
                    statusSpan.textContent = `Error: ${error.message}`; statusSpan.style.color = 'red';
                });
            }

        }); // End DOMContentLoaded

        // --- Sorting Functions ---
        function sortTable(columnIndex, sortType, ascending) {
            const tableBody = document.getElementById('rosterBody');
             if (!tableBody) return;
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const compareFunction = (rowA, rowB) => {
                const cellA = rowA.querySelectorAll('td')[columnIndex];
                const cellB = rowB.querySelectorAll('td')[columnIndex];
                if (!cellA || !cellB) return 0;
                let valueA, valueB;

                if (columnIndex === 2) { // Role column
                    const iconA = cellA.querySelector('i'); const iconB = cellB.querySelector('i');
                    valueA = iconA ? iconA.getAttribute('title') || 'Unknown/N/A' : 'Unknown/N/A';
                    valueB = iconB ? iconB.getAttribute('title') || 'Unknown/N/A' : 'Unknown/N/A';
                } else { // Other columns (including Status at index 6)
                    // For status column, get text from the inner span if it exists
                    const innerSpanA = cellA.querySelector('.display-value span');
                    const innerSpanB = cellB.querySelector('.display-value span');
                    valueA = innerSpanA ? innerSpanA.textContent.trim() : (cellA.querySelector('.na-value') ? 'N/A' : cellA.textContent.trim());
                    valueB = innerSpanB ? innerSpanB.textContent.trim() : (cellB.querySelector('.na-value') ? 'N/A' : cellB.textContent.trim());
                }
                const isValueANa = valueA === 'N/A' || valueA === 'Unknown/N/A';
                const isValueBNa = valueB === 'N/A' || valueB === 'Unknown/N/A';
                if (isValueANa && isValueBNa) return 0; if (isValueANa) return 1; if (isValueBNa) return -1;
                if (sortType === 'number') { valueA = parseFloat(valueA) || 0; valueB = parseFloat(valueB) || 0; }
                else { valueA = valueA.toLowerCase(); valueB = valueB.toLowerCase(); }
                if (valueA < valueB) { return ascending ? -1 : 1; } if (valueA > valueB) { return ascending ? 1 : -1; } return 0;
            };
            rows.sort(compareFunction);
            rows.forEach(row => tableBody.appendChild(row));
        }
        function updateSortArrows(headers, activeColumnIndex, ascending) {
             headers.forEach(header => {
                const arrowSpan = header.querySelector('.sort-arrow');
                if (arrowSpan) {
                    const colIndex = parseInt(header.dataset.columnIndex);
                    arrowSpan.classList.remove('asc', 'desc');
                    if (colIndex === activeColumnIndex) { arrowSpan.classList.add(ascending ? 'asc' : 'desc'); }
                }
             });
        }
    </script>

</body>
</html>
