<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ guild_name }} - Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; /* gray-100 */ }
        th {
            text-align: left; padding: 0.5rem 0.75rem; background-color: #f7fafc; /* gray-100 */
            border-bottom: 2px solid #e2e8f0; /* gray-300 */ font-weight: 600; /* Semibold */
            white-space: nowrap;
        }
        /* Clickable sortable headers */
        th.sortable { cursor: pointer; position: relative; }
        th.sortable:hover { background-color: #edf2f7; /* gray-200 */ }
        /* Sort arrows */
        .sort-arrow {
            font-size: 0.8em; margin-left: 0.3em; color: #a0aec0; /* gray-500 */ position: absolute;
            right: 0.5rem; top: 50%; transform: translateY(-50%); width: 1em; text-align: center;
        }
        .sort-arrow.asc::after { content: '\25B2'; } /* Up arrow ▲ */
        .sort-arrow.desc::after { content: '\25BC'; } /* Down arrow ▼ */
        /* Table cell styles */
        td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #e2e8f0; /* gray-300 */ vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        /* Utility styles */
        .na-value { color: #a0aec0; /* gray-500 */ font-style: italic; }
        .armory-link { color: #2b6cb0; /* blue-700 */ text-decoration: none; }
        .armory-link:hover { color: #2c5282; /* blue-800 */ text-decoration: underline; }
        .role-icon { font-size: 1.1rem; width: 1.5em; text-align: center; display: inline-block; }
        /* Updated Role Colors */
        .role-tank { color: #2563eb; } /* blue-600 */
        .role-healer { color: #16a34a; } /* green-600 */
        .role-melee-dps { color: #dc2626; } /* red-600 */
        .role-ranged-dps { color: #f59e0b; } /* amber-500 */
        .role-dps { color: #c53030; } /* Original DPS color for fallback */
        .role-unknown { color: #a0aec0; } /* gray-500 */


        /* Styles for Editing (shared for spec and status) */
        .display-value { display: inline-block; margin-right: 5px;}
        .edit-btn {
            cursor: pointer; color: #a0aec0; font-size: 0.8em; vertical-align: middle; display: inline-block;
            padding: 1px 3px; border-radius: 3px; margin-left: 4px;
        }
        .edit-btn:hover { color: #4a5568; background-color: #e2e8f0;}
        .edit-control { /* Common class for selects */
            display: none; padding: 2px 4px; border: 1px solid #cbd5e0; border-radius: 4px;
            font-size: 0.9em; vertical-align: middle; margin-left: 5px; max-width: 150px;
        }
        .edit-container { display: inline-block; } /* Container for select and save/cancel */
        .save-btn, .cancel-btn {
            display: none; margin-left: 5px; padding: 1px 4px; font-size: 0.8em; border-radius: 3px; cursor: pointer;
            vertical-align: middle; border: 1px solid transparent;
        }
        .save-btn { background-color: #38a169; color: white; border-color: #2f855a;}
        .save-btn:hover { background-color: #2f855a; }
        .cancel-btn { background-color: #e53e3e; color: white; border-color: #c53030;}
        .cancel-btn:hover { background-color: #c53030; }
        .update-status { font-size: 0.8em; margin-left: 5px; font-style: italic; color: #4a5568; }

        /* Status Text Styling */
        .status-wiper { color: #b7791f; font-weight: 500;}
        .status-member { color: #38a169; }
        .status-wiping-alt { color: #718096; }

        /* Filter Toggle Styling */
        .filter-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            color: #4a5563; /* gray-700 */
        }
        .filter-toggle-label input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem; /* h-5 */
            width: 1.25rem; /* w-5 */
            border: 2px solid #cbd5e0; /* border-gray-300 */
            border-radius: 0.25rem; /* rounded */
            margin-right: 0.5rem; /* mr-2 */
            position: relative;
            outline: none;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .filter-toggle-label input[type="checkbox"]:checked {
            background-color: #6B1A51; /* Custom purple */
            border-color: #6B1A51;
        }
        .filter-toggle-label input[type="checkbox"]:checked::after {
            content: '\2713'; /* Checkmark */
            font-size: 0.875rem;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="text-white p-4 shadow-md" style="background-color: #6B1A51;">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                 <img src="{{ url_for('static', filename='images/wot_logo.png') }}"
                      alt="{{ guild_name }} Logo"
                      class="h-8 w-8 rounded-full border-2 border-white">
                 <h1 class="text-xl font-semibold">{{ guild_name }} Portal</h1>
            </div>
            <div class="flex space-x-2">
                <a href="/" class="px-3 py-2 rounded hover:bg-gray-600">Home</a>
                <a href="/roster" class="px-3 py-2 rounded bg-gray-700 font-medium hover:bg-gray-600">Roster</a>
                <a href="#" class="px-3 py-2 rounded hover:bg-gray-600">Raids</a>
                <a href="#" class="px-3 py-2 rounded hover:bg-gray-600">Loot</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto mt-8 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold">Guild Roster</h2>
                 {% if load_duration %}
                 <span class="text-sm text-gray-500">Loaded in {{ load_duration }}s</span>
                 {% endif %}
            </div>

            <div class="mb-4">
                <label for="wiperFilter" class="filter-toggle-label">
                    <input type="checkbox" id="wiperFilter" checked>
                    Show Only "Wiper" Status
                </label>
            </div>
            {% if error_message %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline">{{ error_message }}</span>
            </div>
            {% endif %}

            {% if members %}
            <div class="overflow-x-auto">
                <table id="rosterTable" class="min-w-full whitespace-nowrap">
                    <thead>
                        <tr>
                            <th class="sortable" data-column-index="0" data-sort-type="string">Name <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="1" data-sort-type="number">Level <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="2" data-sort-type="string">Role <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="3" data-sort-type="string">Spec <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="4" data-sort-type="string">Class <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="5" data-sort-type="number">Item Level <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="6" data-sort-type="string">Status <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="7" data-sort-type="string">Progression <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="8" data-sort-type="number">Attendance <span class="sort-arrow"></span></th>
                            <th class="sortable" data-column-index="9" data-sort-type="number">Rank <span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody id="rosterBody">
                        {% for member in members %}
                        {# Added data-class-name attribute to the row #}
                        <tr data-character-id="{{ member.id }}" data-class-id="{{ member.class_id }}" data-class-name="{{ member.class }}" data-api-spec="{{ member.spec_name }}" data-status="{{ member.status }}">
                            <td>
                                <a href="https://worldofwarcraft.blizzard.com/{{ wow_locale }}/character/{{ wow_region }}/{{ member.realm_slug }}/{{ member.name | urlencode }}"
                                   target="_blank" rel="noopener noreferrer" class="armory-link">
                                    {{ member.name }}
                                </a>
                            </td>
                            <td>{{ member.level }}</td>
                             <td class="text-center role-cell">
                                {# Jinja logic for new roles #}
                                {% set role_lower = member.role | lower if member.role else '' %}
                                {% if role_lower == 'melee dps' %} <i class="fa-solid fa-swords role-icon role-melee-dps" title="Melee DPS"></i>
                                {% elif role_lower == 'ranged dps' %} <i class="fa-solid fa-wand-sparkles role-icon role-ranged-dps" title="Ranged DPS"></i>
                                {% elif role_lower == 'healer' %} <i class="fa-solid fa-briefcase-medical role-icon role-healer" title="Healer"></i>
                                {% elif role_lower == 'tank' %} <i class="fa-solid fa-shield-halved role-icon role-tank" title="Tank"></i>
                                {% elif role_lower == 'dps' %} <i class="fa-solid fa-khanda role-icon role-dps" title="DPS"></i>
                                {% else %} <i class="fa-solid fa-question role-icon role-unknown" title="Unknown/N/A"></i> {% endif %}
                            </td>
                            <td> {# Spec Column #}
                                <span class="spec-display display-value">
                                    {% if member.main_spec_override %} {{ member.main_spec_override }}
                                    {% elif member.spec_name == "N/A" or member.spec_name is none %} <span class="na-value">N/A</span>
                                    {% else %} {{ member.spec_name }} {% endif %}
                                </span>
                                <i class="fas fa-pencil-alt edit-btn edit-spec-btn" title="Set Main Spec"></i>
                                <div class="edit-container spec-edit-container">
                                    <select class="edit-control spec-select"> </select>
                                    <button class="save-btn spec-save-btn">Save</button>
                                    <button class="cancel-btn spec-cancel-btn">Cancel</button>
                                </div>
                                <span class="update-status spec-update-status"></span>
                            </td>
                            <td>{{ member.class }}</td>
                             <td>
                                {% if member.item_level == "N/A" or member.item_level is none %} <span class="na-value">N/A</span> {% else %} {{ member.item_level }} {% endif %}
                            </td>
                            <td> {# Status Column #}
                                <span class="status-display display-value">
                                     {% set status_lower = member.status | lower if member.status else '' %}
                                     <span class="
                                         {% if status_lower == 'wiper' %} status-wiper
                                         {% elif status_lower == 'member' %} status-member
                                         {% elif status_lower == 'wiping alt' %} status-wiping-alt
                                         {% endif %}">
                                         {{ member.status | default('Unknown') }}
                                     </span>
                                </span>
                                <i class="fas fa-pencil-alt edit-btn edit-status-btn" title="Set Status"></i>
                                <div class="edit-container status-edit-container">
                                    <select class="edit-control status-select">
                                        <option value="Wiper">Wiper</option>
                                        <option value="Member">Member</option>
                                        <option value="Wiping Alt">Wiping Alt</option>
                                    </select>
                                    <button class="save-btn status-save-btn">Save</button>
                                    <button class="cancel-btn status-cancel-btn">Cancel</button>
                                </div>
                                <span class="update-status status-update-status"></span>
                            </td>
                            <td>
                                {% if member.raid_progression == "N/A" or member.raid_progression is none %} <span class="na-value">N/A</span> {% else %} {{ member.raid_progression }} {% endif %}
                            </td>
                            <td>
                                {% if member.raid_attendance_percentage is none %}
                                    <span class="na-value">N/A</span>
                                {% else %}
                                    {{ "%.1f%%" | format(member.raid_attendance_percentage) }}
                                {% endif %}
                            </td>
                            <td>{{ member.rank }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% elif not error_message %}
            <p>No members found matching rank criteria (<= 4) and item level (>= 600) in the database.</p>
            {% endif %}
        </div>
    </main>

    <footer class="text-center text-gray-500 mt-8 pb-4">
        &copy; {{ guild_name }} - {{ current_year }}
    </footer>

    <script>
        const allSpecsByClass = JSON.parse('{{ all_specs_by_class | safe }}' || '{}');

        // --- Role Determination Logic ---
        const tankSpecs = ["Blood", "Protection", "Guardian", "Brewmaster", "Vengeance"];
        const healerSpecs = ["Holy", "Discipline", "Restoration", "Mistweaver", "Preservation"];
        const meleeDpsSpecs = {
            "Warrior": ["Arms", "Fury"], "Paladin": ["Retribution"], "Death Knight": ["Frost", "Unholy"],
            "Shaman": ["Enhancement"], "Hunter": ["Survival"], "Rogue": ["Assassination", "Outlaw", "Subtlety"],
            "Monk": ["Windwalker"], "Demon Hunter": ["Havoc"], "Druid": ["Feral"]
        };
        const rangedDpsSpecs = {
            "Mage": ["Arcane", "Fire", "Frost"], "Warlock": ["Affliction", "Demonology", "Destruction"],
            "Priest": ["Shadow"], "Hunter": ["Beast Mastery", "Marksmanship"], "Druid": ["Balance"],
            "Shaman": ["Elemental"], "Evoker": ["Devastation", "Augmentation"]
        };

        function getRoleFromSpec(specName, className) {
            console.log("[getRoleFromSpec] Input - Spec:", specName, "Class:", className); // DEBUG
            if (!specName || specName === 'N/A') {
                console.log("[getRoleFromSpec] -> Unknown (no specName)");
                return 'Unknown';
            }
            if (tankSpecs.includes(specName)) {
                console.log("[getRoleFromSpec] -> Tank");
                return 'Tank';
            }
            if (healerSpecs.includes(specName)) {
                console.log("[getRoleFromSpec] -> Healer");
                return 'Healer';
            }
            // Check Melee DPS by class and spec
            if (className && meleeDpsSpecs[className] && meleeDpsSpecs[className].includes(specName)) {
                console.log("[getRoleFromSpec] -> Melee DPS for class:", className, "spec:", specName);
                return 'Melee DPS';
            }
            // Check Ranged DPS by class and spec
            if (className && rangedDpsSpecs[className] && rangedDpsSpecs[className].includes(specName)) {
                console.log("[getRoleFromSpec] -> Ranged DPS for class:", className, "spec:", specName);
                return 'Ranged DPS';
            }
            // Fallback for generic DPS if spec is known but not in detailed lists
            if (specName) {
                console.log("[getRoleFromSpec] -> DPS (fallback) for spec:", specName);
                return 'DPS';
            }
            console.log("[getRoleFromSpec] -> Unknown (default end)");
            return 'Unknown';
        }

        // --- UI Update Functions ---
        function updateRoleIcon(tableRow, newRole) {
            const roleCell = tableRow.querySelector('.role-cell');
            if (!roleCell) return;
            const icon = roleCell.querySelector('i');
            if (!icon) return;
            icon.className = 'role-icon fa-solid'; // Reset classes
            let iconClass = 'fa-question', colorClass = 'role-unknown', title = 'Unknown/N/A';

            const roleLower = newRole ? newRole.toLowerCase() : 'unknown'; // Ensure newRole is a string
            console.log("[updateRoleIcon] newRole:", newRole, "roleLower:", roleLower); // DEBUG

            if (roleLower === 'melee dps') { iconClass = 'fa-swords'; colorClass = 'role-melee-dps'; title = 'Melee DPS'; }
            else if (roleLower === 'ranged dps') { iconClass = 'fa-wand-sparkles'; colorClass = 'role-ranged-dps'; title = 'Ranged DPS'; }
            else if (roleLower === 'healer') { iconClass = 'fa-briefcase-medical'; colorClass = 'role-healer'; title = 'Healer'; }
            else if (roleLower === 'tank') { iconClass = 'fa-shield-halved'; colorClass = 'role-tank'; title = 'Tank'; }
            else if (roleLower === 'dps') { iconClass = 'fa-khanda'; colorClass = 'role-dps'; title = 'DPS'; } // Fallback for generic DPS

            icon.classList.add(iconClass, colorClass);
            icon.setAttribute('title', title);
            console.log("[updateRoleIcon] Applied classes:", icon.className, "Applied title:", title); // DEBUG
        }

        function updateStatusDisplay(displaySpan, newStatus) { /* ... as before ... */
             const innerSpan = displaySpan.querySelector('span');
             if (!innerSpan) return;
             innerSpan.className = '';
             if (newStatus) {
                 const statusClass = 'status-' + newStatus.toLowerCase().replace(' ', '-');
                 innerSpan.classList.add(statusClass);
             }
             innerSpan.textContent = newStatus || 'Unknown';
        }


        // --- Main Script Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('rosterTable');
            const tableBody = document.getElementById('rosterBody');
            if (!table || !tableBody) { console.error("Roster table or body not found!"); return; }
            const headers = table.querySelectorAll('th.sortable');
            let currentSort = { column: -1, ascending: true };

            // Sorting Event Listeners
            headers.forEach(header => { /* ... as before ... */
                header.addEventListener('click', function() {
                    const columnIndex = parseInt(this.dataset.columnIndex);
                    const sortType = this.dataset.sortType || 'string';
                    let ascending = (currentSort.column === columnIndex) ? !currentSort.ascending : true;
                    currentSort = { column: columnIndex, ascending: ascending };
                    sortTable(columnIndex, sortType, ascending);
                    updateSortArrows(headers, columnIndex, ascending);
                });
            });

            // Editing Event Listeners
            tableBody.addEventListener('click', function(event) { /* ... as before ... */
                if (event.target.classList.contains('edit-spec-btn')) { startEdit(event.target, 'spec'); }
                else if (event.target.classList.contains('spec-save-btn')) { saveEdit(event.target, 'spec'); }
                else if (event.target.classList.contains('spec-cancel-btn')) { cancelEdit(event.target, 'spec'); }
                else if (event.target.classList.contains('edit-status-btn')) { startEdit(event.target, 'status'); }
                else if (event.target.classList.contains('status-save-btn')) { saveEdit(event.target, 'status'); }
                else if (event.target.classList.contains('status-cancel-btn')) { cancelEdit(event.target, 'status'); }
            });

            // Wiper Filter Initial Apply and Event Listener
            const wiperFilterCheckbox = document.getElementById('wiperFilter');
            if (wiperFilterCheckbox) {
                applyWiperFilter();
                wiperFilterCheckbox.addEventListener('change', applyWiperFilter);
            }


            // Generic Editing Functions
            function startEdit(editButton, type) { /* ... as before ... */
                const td = editButton.closest('td');
                const tr = editButton.closest('tr');
                const displaySpan = td.querySelector(`.${type}-display`);
                const selectContainer = td.querySelector(`.${type}-edit-container`);
                const select = selectContainer.querySelector(`.${type}-select`);
                const saveBtn = selectContainer.querySelector(`.${type}-save-btn`);
                const cancelBtn = selectContainer.querySelector(`.${type}-cancel-btn`);
                const statusSpan = td.querySelector(`.${type}-update-status`);
                const currentDisplayedValue = (type === 'status') ? displaySpan.querySelector('span').textContent.trim() : displaySpan.textContent.trim();

                if (type === 'spec') {
                    const classId = tr.dataset.classId;
                    const specsForClass = allSpecsByClass[classId] || [];
                    select.innerHTML = '<option value="">-- Use API Spec --</option>';
                    specsForClass.forEach(spec => {
                        const option = document.createElement('option');
                        option.value = spec.name; option.textContent = spec.name;
                        if (currentDisplayedValue === spec.name && !displaySpan.querySelector('.na-value')) { option.selected = true; }
                        select.appendChild(option);
                    });
                } else if (type === 'status') {
                     Array.from(select.options).forEach(option => { option.selected = (option.value === currentDisplayedValue); });
                }
                displaySpan.style.display = 'none'; editButton.style.display = 'none';
                selectContainer.style.display = 'inline-block'; select.style.display = 'inline-block';
                saveBtn.style.display = 'inline-block'; cancelBtn.style.display = 'inline-block';
                statusSpan.textContent = '';
            }

            function cancelEdit(cancelButton, type) { /* ... as before ... */
                 const td = cancelButton.closest('td');
                 const displaySpan = td.querySelector(`.${type}-display`);
                 const editButton = td.querySelector(`.edit-${type}-btn`);
                 const selectContainer = td.querySelector(`.${type}-edit-container`);
                 selectContainer.style.display = 'none';
                 displaySpan.style.display = 'inline-block';
                 editButton.style.display = 'inline-block';
            }

            function saveEdit(saveButton, type) { /* ... as before ... */
                const td = saveButton.closest('td');
                const tr = saveButton.closest('tr');
                const select = td.querySelector(`.${type}-select`);
                const statusSpan = td.querySelector(`.${type}-update-status`);
                const characterId = tr.dataset.characterId;
                const selectedValue = select.value;

                if (!characterId) { return; }
                statusSpan.textContent = 'Saving...'; statusSpan.style.color = '#4a5568';
                let endpoint = ''; let payload = {};
                if (type === 'spec') {
                    endpoint = '/update_spec';
                    payload = { character_id: parseInt(characterId), spec_name: selectedValue };
                } else if (type === 'status') {
                    endpoint = '/update_status';
                    payload = { character_id: parseInt(characterId), status: selectedValue };
                } else { return; }

                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error ${response.status}`); }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        statusSpan.textContent = 'Saved!'; statusSpan.style.color = 'green';
                        const displaySpan = td.querySelector(`.${type}-display`);
                        if (type === 'spec') {
                            const apiSpecName = tr.dataset.apiSpec;
                            let finalSpecName = selectedValue ? selectedValue : apiSpecName;
                            displaySpan.textContent = (finalSpecName && finalSpecName !== "N/A") ? finalSpecName : '';
                            if (!displaySpan.textContent) displaySpan.innerHTML = '<span class="na-value">N/A</span>';
                            const className = tr.dataset.className; // Get class name from row
                            const newRole = getRoleFromSpec(finalSpecName, className); // Pass class name
                            updateRoleIcon(tr, newRole);
                        } else if (type === 'status') {
                             updateStatusDisplay(displaySpan, selectedValue);
                             tr.dataset.status = selectedValue;
                             applyWiperFilter();
                        }
                        setTimeout(() => { cancelEdit(saveButton, type); statusSpan.textContent = ''; }, 1500);
                    } else { throw new Error(data.message || "Unknown error saving data."); }
                })
                .catch(error => {
                    console.error(`Error updating ${type}:`, error);
                    statusSpan.textContent = `Error: ${error.message}`; statusSpan.style.color = 'red';
                });
            }

        }); // End DOMContentLoaded

        // --- Sorting Functions ---
        function sortTable(columnIndex, sortType, ascending) { /* ... as before ... */
            const tableBody = document.getElementById('rosterBody');
             if (!tableBody) return;
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const compareFunction = (rowA, rowB) => {
                const cellA = rowA.querySelectorAll('td')[columnIndex];
                const cellB = rowB.querySelectorAll('td')[columnIndex];
                if (!cellA || !cellB) return 0;
                let valueA, valueB;

                if (columnIndex === 2) { // Role column
                    const iconA = cellA.querySelector('i'); const iconB = cellB.querySelector('i');
                    valueA = iconA ? iconA.getAttribute('title') || 'Unknown/N/A' : 'Unknown/N/A';
                    valueB = iconB ? iconB.getAttribute('title') || 'Unknown/N/A' : 'Unknown/N/A';
                } else { // Other columns
                    const innerSpanA = cellA.querySelector('.display-value span');
                    const innerSpanB = cellB.querySelector('.display-value span');
                    valueA = innerSpanA ? innerSpanA.textContent.trim() : (cellA.querySelector('.na-value') ? 'N/A' : cellA.textContent.trim());
                    valueB = innerSpanB ? innerSpanB.textContent.trim() : (cellB.querySelector('.na-value') ? 'N/A' : cellB.textContent.trim());
                }
                const isValueANa = valueA === 'N/A' || valueA === 'Unknown/N/A';
                const isValueBNa = valueB === 'N/A' || valueB === 'Unknown/N/A';
                if (isValueANa && isValueBNa) return 0; if (isValueANa) return 1; if (isValueBNa) return -1;
                if (sortType === 'number') {
                    if (columnIndex === 8) { // Attendance column
                        valueA = parseFloat(valueA.replace('%','')) || 0;
                        valueB = parseFloat(valueB.replace('%','')) || 0;
                    } else {
                        valueA = parseFloat(valueA) || 0;
                        valueB = parseFloat(valueB) || 0;
                    }
                }
                else { valueA = valueA.toLowerCase(); valueB = valueB.toLowerCase(); }
                if (valueA < valueB) { return ascending ? -1 : 1; } if (valueA > valueB) { return ascending ? 1 : -1; } return 0;
            };
            rows.sort(compareFunction);
            rows.forEach(row => tableBody.appendChild(row));
        }
        function updateSortArrows(headers, activeColumnIndex, ascending) { /* ... as before ... */
             headers.forEach(header => {
                const arrowSpan = header.querySelector('.sort-arrow');
                if (arrowSpan) {
                    const colIndex = parseInt(header.dataset.columnIndex);
                    arrowSpan.classList.remove('asc', 'desc');
                    if (colIndex === activeColumnIndex) { arrowSpan.classList.add(ascending ? 'asc' : 'desc'); }
                }
             });
        }
        // --- Wiper Filter Function ---
        function applyWiperFilter() {
            const wiperFilterCheckbox = document.getElementById('wiperFilter');
            const rosterTableBody = document.getElementById('rosterBody');
            if (!rosterTableBody || !wiperFilterCheckbox) return;
            const showOnlyWipers = wiperFilterCheckbox.checked;
            const rows = rosterTableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const status = row.dataset.status;
                if (showOnlyWipers) {
                    if (status === 'Wiper') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                } else {
                    row.style.display = '';
                }
            });
        }
    </script>

</body>
</html>
