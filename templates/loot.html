<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ guild_name }} - BiS Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; /* gray-100 */ }
        .nav-link-active {
            background-color: #4a5568; /* gray-700 for active link */
        }
        .slot-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
            gap: 1rem;
        }
        .slot-card {
            background-color: #fff;
            border: 1px solid #e2e8f0; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .slot-name {
            font-weight: 600;
            color: #2d3748; /* gray-800 */
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .item-display {
            font-size: 0.875rem;
            color: #4a5563; /* gray-700 */
            min-height: 40px; /* Ensure space even if empty */
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .item-icon {
            width: 32px;
            height: 32px;
            margin-right: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            background-color: #edf2f7; /* gray-200 placeholder */
            display: inline-block;
            object-fit: cover; /* Ensure icon fits well */
        }
        .bis-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem;
            background-color: #fff;
        }
        .character-select-label {
            font-weight: 500;
            color: #2d3748; /* gray-800 */
            margin-bottom: 0.25rem;
        }
        .character-select {
            width: 100%;
            max-width: 400px; /* Limit width of character select */
            padding: 0.625rem; /* p-2.5 */
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 1.5rem; /* mb-6 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="text-white p-4 shadow-md" style="background-color: #6B1A51;">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                 <img src="{{ url_for('static', filename='images/wot_logo.png') }}"
                      alt="{{ guild_name }} Logo"
                      class="h-8 w-8 rounded-full border-2 border-white">
                 <h1 class="text-xl font-semibold">{{ guild_name }} Portal</h1>
            </div>
            <div class="flex space-x-2">
                <a href="{{ url_for('home') }}" class="px-3 py-2 rounded hover:bg-gray-600">Home</a>
                <a href="{{ url_for('roster_page') }}" class="px-3 py-2 rounded hover:bg-gray-600">Roster</a>
                <a href="{{ url_for('raids_page') }}" class="px-3 py-2 rounded hover:bg-gray-600">Raids</a>
                <a href="{{ url_for('loot_page') }}" class="px-3 py-2 rounded nav-link-active font-medium">Loot</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto mt-8 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-gray-900">Best-in-Slot Planner</h2>

            <div class="mb-6">
                <label for="characterSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Character:</label>
                <select id="characterSelect" class="character-select">
                    <option value="">-- Select a Wiper --</option>
                    {% for wiper in wipers %}
                        <option value="{{ wiper.id }}" data-class-name="{{ wiper.class_name }}">{{ wiper.name }} ({{ wiper.class_name }})</option>
                    {% endfor %}
                </select>
            </div>

            <div id="gearSlotsContainer" class="slot-container">
                {# Slots will be populated by JavaScript #}
                {% if playable_slots %}
                    {% for slot in playable_slots %}
                        <div class="slot-card" data-slot-type="{{ slot.type }}">
                            <h3 class="slot-name">{{ slot.name }}</h3>
                            <div class="mb-2">
                                <p class="text-xs text-gray-500 mb-1">Equipped:</p>
                                <div class="item-display equipped-item-display" id="equipped-{{ slot.type }}">
                                    <img src="https://placehold.co/32x32/CCCCCC/999999?text=?" alt="Equipped Item" class="item-icon equipped-item-icon">
                                    <span class="equipped-item-name">None</span>
                                </div>
                            </div>
                            <div>
                                <label for="bis-{{ slot.type }}" class="block text-xs text-gray-500 mb-1">Best in Slot:</label>
                                <select id="bis-{{ slot.type }}" class="bis-select" data-slot-type="{{ slot.type }}">
                                    <option value="">-- Select BiS --</option>
                                    {# BiS options will be populated by JavaScript #}
                                </select>
                            </div>
                             <span class="update-status text-xs italic mt-2" id="status-{{ slot.type }}"></span>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500">Playable slots not loaded. Please run the item database population script.</p>
                {% endif %}
            </div>
        </div>
    </main>

    <footer class="text-center text-gray-500 mt-8 pb-4">
        &copy; {{ guild_name }} - {{ current_year }}
    </footer>

    <script>
        // Pass data from Flask to JavaScript
        const playableSlots = {{ playable_slots | tojson | safe }};
        const characterSelect = document.getElementById('characterSelect');
        const gearSlotsContainer = document.getElementById('gearSlotsContainer');

        document.addEventListener('DOMContentLoaded', function() {
            // Event listener for character selection
            characterSelect.addEventListener('change', function() {
                const characterId = this.value;
                const selectedOption = this.options[this.selectedIndex];
                const className = selectedOption.dataset.className;

                if (characterId) {
                    console.log(`Character selected: ID=${characterId}, Class=${className}`);
                    loadCharacterGear(characterId);
                } else {
                    // Clear gear display if no character is selected
                    clearGearDisplay();
                }
            });

            // Event listeners for BiS dropdown changes (delegated)
            gearSlotsContainer.addEventListener('change', function(event) {
                if (event.target.classList.contains('bis-select')) {
                    const characterId = characterSelect.value;
                    const slotType = event.target.dataset.slotType;
                    const itemId = event.target.value;
                    const statusSpan = document.getElementById(`status-${slotType}`);

                    if (characterId && slotType && itemId) {
                        saveBisSelection(characterId, slotType, itemId, statusSpan);
                    } else if (characterId && slotType && itemId === "") { // Clearing BiS
                        saveBisSelection(characterId, slotType, null, statusSpan); // Send null or handle differently
                    }
                }
            });
        });

        function clearGearDisplay() {
            playableSlots.forEach(slot => {
                const equippedItemDiv = document.getElementById(`equipped-${slot.type}`);
                if (equippedItemDiv) {
                    equippedItemDiv.querySelector('.equipped-item-name').textContent = 'None';
                    equippedItemDiv.querySelector('.equipped-item-icon').src = 'https://placehold.co/32x32/CCCCCC/999999?text=?';
                }
                const bisSelect = document.getElementById(`bis-${slot.type}`);
                if (bisSelect) {
                    bisSelect.innerHTML = '<option value="">-- Select BiS --</option>';
                }
                 const statusSpan = document.getElementById(`status-${slot.type}`);
                if(statusSpan) statusSpan.textContent = '';
            });
        }

        async function loadCharacterGear(characterId) {
            console.log(`Fetching equipped items for character ID: ${characterId}`);
            try {
                const response = await fetch(`/api/character_equipped_items/${characterId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`Error fetching equipped items: ${response.status}`, errorData.error);
                    clearGearDisplay(); // Clear on error
                    // Optionally display an error message to the user
                    return;
                }
                const equippedItems = await response.json();
                console.log("Equipped items data:", equippedItems);

                // Populate equipped items and then BiS dropdowns
                playableSlots.forEach(slot => {
                    const equippedItemDiv = document.getElementById(`equipped-${slot.type}`);
                    const equippedItemNameSpan = equippedItemDiv.querySelector('.equipped-item-name');
                    const equippedItemIconImg = equippedItemDiv.querySelector('.equipped-item-icon');
                    const bisSelect = document.getElementById(`bis-${slot.type}`);

                    const equippedItem = equippedItems[slot.type];
                    if (equippedItem) {
                        equippedItemNameSpan.textContent = equippedItem.name;
                        // For now, icon URL is not fetched from Blizzard API in the backend
                        // equippedItemIconImg.src = equippedItem.icon_url || 'https://placehold.co/32x32/CCCCCC/999999?text=?';
                        // We'll need to fetch item media separately if we want actual icons
                        // For now, let's use a placeholder or remove the icon display
                        equippedItemIconImg.alt = equippedItem.name;
                    } else {
                        equippedItemNameSpan.textContent = 'None';
                        equippedItemIconImg.src = 'https://placehold.co/32x32/CCCCCC/999999?text=?';
                        equippedItemIconImg.alt = 'No item equipped';
                    }
                    // After populating equipped, load BiS options for this slot
                    loadBisOptions(slot.type, equippedItem ? equippedItem.item_id : null, characterId);
                });

            } catch (error) {
                console.error('Failed to load character gear:', error);
                clearGearDisplay();
            }
        }

        async function loadBisOptions(slotType, equippedItemId, characterId) {
            const bisSelect = document.getElementById(`bis-${slotType}`);
            if (!bisSelect) return;

            console.log(`Loading BiS options for slot: ${slotType}, Character ID: ${characterId}`);

            try {
                // Fetch available items for this slot from our DB cache
                const itemsResponse = await fetch(`/api/available_items/${slotType}`);
                if (!itemsResponse.ok) throw new Error(`Failed to fetch available items for ${slotType}`);
                const availableItems = await itemsResponse.json();

                // Fetch current BiS selection for this character and slot
                const currentBisResponse = await fetch(`/api/bis_selection/${characterId}/${slotType}`);
                let currentBisItemId = null;
                if (currentBisResponse.ok) {
                    const bisData = await currentBisResponse.json();
                    if (bisData && bisData.item_id) {
                        currentBisItemId = bisData.item_id;
                    }
                } else if (currentBisResponse.status !== 404) { // 404 is fine, means no selection yet
                    console.warn(`Failed to fetch current BiS for ${slotType}`);
                }


                bisSelect.innerHTML = '<option value="">-- Select BiS --</option>'; // Default empty option
                // Add currently equipped item as an option if it exists and is not already in availableItems (by ID)
                const equippedItemDisplay = document.getElementById(`equipped-${slotType}`);
                const equippedItemName = equippedItemDisplay.querySelector('.equipped-item-name').textContent;

                if (equippedItemId && equippedItemName !== 'None') {
                     // Check if equipped item is already in the list from the DB
                    const equippedInAvailable = availableItems.some(item => item.id === equippedItemId);
                    if (!equippedInAvailable) {
                        const equippedOption = document.createElement('option');
                        equippedOption.value = equippedItemId;
                        equippedOption.textContent = `${equippedItemName} (Equipped)`;
                        bisSelect.appendChild(equippedOption);
                    }
                }


                availableItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    if (item.source_details) {
                        option.textContent += ` (${item.source_details})`;
                    }
                    bisSelect.appendChild(option);
                });

                // Set the selected value for the BiS dropdown
                if (currentBisItemId) {
                    bisSelect.value = currentBisItemId;
                } else if (equippedItemId) { // Default to equipped if no BiS is saved
                    bisSelect.value = equippedItemId;
                }


            } catch (error) {
                console.error(`Error loading BiS options for ${slotType}:`, error);
                bisSelect.innerHTML = '<option value="">Error loading items</option>';
            }
        }

        async function saveBisSelection(characterId, slotType, itemId, statusSpan) {
            console.log(`Saving BiS: CharID=${characterId}, Slot=${slotType}, ItemID=${itemId}`);
            statusSpan.textContent = 'Saving...';
            statusSpan.style.color = '#4a5563'; // Default text color

            try {
                const response = await fetch('/api/bis_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        // Add CSRF token if/when implemented
                    },
                    body: JSON.stringify({
                        character_id: parseInt(characterId),
                        slot_type: slotType,
                        item_id: itemId ? parseInt(itemId) : null // Send null if clearing selection
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ description: "Unknown error" }));
                    throw new Error(errorData.description || `HTTP error ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    statusSpan.textContent = 'Saved!';
                    statusSpan.style.color = 'green';
                } else {
                    throw new Error(data.message || "Failed to save BiS selection.");
                }
            } catch (error) {
                console.error('Error saving BiS selection:', error);
                statusSpan.textContent = `Error: ${error.message}`;
                statusSpan.style.color = 'red';
            }
            setTimeout(() => { statusSpan.textContent = ''; }, 3000); // Clear status after 3s
        }

    </script>

</body>
</html>
